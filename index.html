<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Cuotas Bancarias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background-color: #f5f5f5;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        .admin-gear {
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            transition: transform 0.3s, color 0.3s;
            padding: 10px;
        }
        .admin-gear:hover {
            color: #3498db;
            transform: rotate(90deg);
        }
        .calculator {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #219653;
        }
        button.whatsapp {
            background-color: #25D366;
            margin-top: 20px;
        }
        button.whatsapp:hover {
            background-color: #128C7E;
        }
        #result {
            margin-top: 25px;
            display: none;
        }
        .result-container {
            background-color: #e8f8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #27ae60;
        }
        .bank-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            font-weight: bold;
            color: #e74c3c;
        }
        .cutoff-date {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
        }
        .summary {
            margin-bottom: 15px;
        }
        .summary-item {
            margin-bottom: 8px;
        }
        .whatsapp-container {
            text-align: center;
            margin-top: 20px;
        }
        .date-toggle {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .date-toggle input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        .disclaimer {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 15px;
            font-style: italic;
            text-align: center;
        }
        .admin-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 700px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .admin-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .admin-section {
            margin-bottom: 20px;
        }
        .admin-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 18px;
        }
        .pin-input {
            margin-bottom: 20px;
        }
        .close-admin {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .close-admin:hover {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Calculadora de Cuotas Bancarias</h1>
        <i class="fas fa-cog admin-gear" onclick="toggleAdminPanel()"></i>
    </div>
    
    <div class="calculator">
        <div class="form-group">
            <label for="monto">Monto total a financiar (C$):</label>
            <input type="number" id="monto" placeholder="Ej: 10000" step="0.01" min="1">
        </div>
        
        <div class="form-group">
            <label for="banco">Banco:</label>
            <select id="banco">
                <option value="">Seleccione un banco</option>
                <option value="bac">BAC</option>
                <option value="banpro">Banpro</option>
                <option value="ficohsa">Ficohsa</option>
                <option value="lafise">Lafise</option>
            </select>
        </div>
        
        <div class="form-group">
            <div class="date-toggle">
                <input type="checkbox" id="usarFechaCorte" checked onchange="toggleFechaCorte()">
                <label for="usarFechaCorte">Usar fecha de corte</label>
            </div>
            <input type="date" id="fechaCorte" style="margin-top: 5px;">
        </div>
        
        <button onclick="calcularCuotas()">Calcular Cuotas</button>
        
        <div id="result">
            <div class="result-container" id="result-content">
                <!-- Contenido generado dinámicamente -->
            </div>
            
            <div class="whatsapp-container">
                <button class="whatsapp" onclick="compartirWhatsApp()">
                    Compartir por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Panel de administración -->
    <div class="admin-overlay" id="adminOverlay"></div>
    <div class="admin-panel" id="adminPanel">
        <span class="close-admin" onclick="cerrarAdminPanel()">&times;</span>
        <h2>Panel de Administración</h2>
        
        <div class="pin-input" id="pinContainer">
            <label for="pin">Ingrese PIN:</label>
            <input type="password" id="pin" placeholder="PIN de 4 dígitos">
            <button onclick="verificarPin()">Acceder</button>
        </div>
        
        <div id="adminContent" style="display: none;">
            <div class="admin-section">
                <div class="admin-title">Configurar Comisiones Bancarias (%)</div>
                <table>
                    <thead>
                        <tr>
                            <th>Banco</th>
                            <th>3 meses</th>
                            <th>6 meses</th>
                            <th>9 meses</th>
                            <th>12 meses</th>
                            <th>18 meses</th>
                            <th>24 meses</th>
                        </tr>
                    </thead>
                    <tbody id="comisiones-body">
                    </tbody>
                </table>
            </div>
            
            <div class="admin-section">
                <div class="admin-title">Configurar Otros Parámetros</div>
                <div class="form-group">
                    <label for="retencionInput">Retención DGI (%):</label>
                    <input type="number" id="retencionInput" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="papeleriaInput">Costos administrativos (C$):</label>
                    <input type="number" id="papeleriaInput" step="0.01" min="0">
                </div>
            </div>
            
            <div class="admin-section">
                <button onclick="guardarConfiguracion()">Guardar Configuración</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración inicial
        let config = {
            comisiones: {
                bac: { 3: 5, 6: 7, 9: 9, 12: 11 },
                banpro: { 3: 6, 6: 9, 9: 11, 12: 13, 18: 13.5 },
                lafise: { 3: 6, 6: 9, 9: 11, 12: 13 },
                ficohsa: { 3: 5, 6: 7, 9: 10, 12: 12, 18: 16, 24: 18 }
            },
            retencion: 1.5,
            papeleria: 75
        };

        // PIN de administración
        const ADMIN_PIN = "1991";

        // Cargar configuración guardada
        function cargarConfiguracion() {
            const savedConfig = localStorage.getItem('calculadoraConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }
            actualizarTablaComisiones();
            document.getElementById('retencionInput').value = config.retencion;
            document.getElementById('papeleriaInput').value = config.papeleria;
        }

        // Guardar configuración
        function guardarConfiguracion() {
            // Validar que todos los campos de comisiones sean números
            const inputs = document.querySelectorAll('#comisiones-body input');
            for (const input of inputs) {
                if (isNaN(parseFloat(input.value))) {
                    alert("Por favor ingrese valores numéricos válidos en todas las comisiones");
                    return;
                }
            }
            
            // Actualizar configuración
            for (const banco in config.comisiones) {
                for (const plazo in config.comisiones[banco]) {
                    const value = parseFloat(document.getElementById(comision-${banco}-${plazo}).value);
                    config.comisiones[banco][plazo] = value;
                }
            }
            
            config.retencion = parseFloat(document.getElementById('retencionInput').value);
            config.papeleria = parseFloat(document.getElementById('papeleriaInput').value);
            
            localStorage.setItem('calculadoraConfig', JSON.stringify(config));
            alert("Configuración guardada correctamente");
            cerrarAdminPanel();
        }

        // Actualizar tabla de comisiones
        function actualizarTablaComisiones() {
            const comisionesBody = document.getElementById('comisiones-body');
            comisionesBody.innerHTML = '';
            
            for (const [banco, plazos] of Object.entries(config.comisiones)) {
                const row = document.createElement('tr');
                row.innerHTML = <td>${obtenerNombreBanco(banco)}</td>;
                
                for (const plazo of [3, 6, 9, 12, 18, 24]) {
                    if (plazos[plazo] !== undefined) {
                        row.innerHTML += `
                            <td>
                                <input type="number" id="comision-${banco}-${plazo}" 
                                       value="${plazos[plazo]}" step="0.01" min="0">
                            </td>
                        `;
                    } else {
                        row.innerHTML += '<td>-</td>';
                    }
                }
                
                comisionesBody.appendChild(row);
            }
        }

        // Habilitar/deshabilitar fecha de corte
        function toggleFechaCorte() {
            document.getElementById('fechaCorte').disabled = !document.getElementById('usarFechaCorte').checked;
        }

        // Mostrar/ocultar panel de administración
        function toggleAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('pinContainer').style.display = 'block';
            document.getElementById('pin').value = '';
            document.getElementById('pin').focus();
        }

        // Cerrar panel de administración
        function cerrarAdminPanel() {
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // Verificar PIN
        function verificarPin() {
            const pin = document.getElementById('pin').value;
            if (pin === ADMIN_PIN) {
                document.getElementById('adminContent').style.display = 'block';
                document.getElementById('pinContainer').style.display = 'none';
                cargarConfiguracion();
            } else {
                alert("PIN incorrecto");
            }
        }

        // Calcular todas las cuotas para el banco seleccionado
        function calcularCuotas() {
            const monto = parseFloat(document.getElementById('monto').value);
            const bancoId = document.getElementById('banco').value;
            const usarFechaCorte = document.getElementById('usarFechaCorte').checked;
            let fechaCorte = usarFechaCorte ? document.getElementById('fechaCorte').value : null;
            
            // Validaciones
            if (isNaN(monto) || monto <= 0) {
                alert("Por favor ingrese un monto válido");
                return;
            }
            
            if (!bancoId) {
                alert("Por favor seleccione un banco");
                return;
            }
            
            if (usarFechaCorte && !fechaCorte) {
                alert("Por favor ingrese la fecha de corte");
                return;
            }
            
            const bancoNombre = obtenerNombreBanco(bancoId);
            const plazos = config.comisiones[bancoId];
            const fechaCorteObj = usarFechaCorte ? new Date(fechaCorte) : new Date();
            const resultDiv = document.getElementById('result-content');
            
            let resultadoHTML = `
                <div class="bank-name">${bancoNombre}</div>
                <div class="summary">
                    <div class="summary-item">Monto financiado: C$${monto.toLocaleString('es-NI', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            `;
            
            if (usarFechaCorte) {
                resultadoHTML += `
                    <div class="cutoff-date"><strong>Fecha de corte:</strong> ${fechaCorteObj.toLocaleDateString('es-NI', {day: '2-digit', month: 'long', year: 'numeric'})}</div>
                `;
            }
            
            resultadoHTML += `
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Plazo</th>
                            <th>Cuota Mensual</th>
                            <th>Total a Pagar</th>
            `;
            
            resultadoHTML += usarFechaCorte ? '<th>Fecha aprox. de pago</th>' : '';
            
            resultadoHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Calcular para cada plazo del banco
            for (const [plazoStr, comisionPorcentaje] of Object.entries(plazos)) {
                const plazo = parseInt(plazoStr);
                
                // Aplicar fórmula: Total = (Monto + Papelería) / ((1 - retención) * (1 - comisión))
                const factorRetencion = (100 - config.retencion) / 100;
                const factorComision = (100 - comisionPorcentaje) / 100;
                const totalPagar = (monto + config.papeleria) / (factorRetencion * factorComision);
                const cuotaMensual = totalPagar / plazo;
                
                resultadoHTML += `
                    <tr>
                        <td>${plazo} meses</td>
                        <td class="highlight">C$${cuotaMensual.toLocaleString('es-NI', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>C$${totalPagar.toLocaleString('es-NI', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                `;
                
                if (usarFechaCorte) {
                    // Calcular fecha aproximada de pago (fecha de corte + 21 días + mes correspondiente)
                    const fechaPago = new Date(fechaCorteObj);
                    fechaPago.setDate(fechaPago.getDate() + 21);
                    fechaPago.setMonth(fechaPago.getMonth() + 1);
                    
                    resultadoHTML += `
                        <td>${fechaPago.toLocaleDateString('es-NI', {day: '2-digit', month: 'short', year: 'numeric'})}</td>
                    `;
                }
                
                resultadoHTML += </tr>;
            }
            
            resultadoHTML += `
                    </tbody>
                </table>
            `;
            
            if (usarFechaCorte) {
                resultadoHTML += `
                    <div class="disclaimer">
                        * La fecha de pago es aproximada y solo a modo de referencia. No representa el día exacto de pago.
                    </div>
                `;
            }
            
            resultDiv.innerHTML = resultadoHTML;
            
            // Mostrar resultados
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Compartir por WhatsApp (texto)
        function compartirWhatsApp() {
            const monto = document.getElementById('monto').value;
            const bancoNombre = obtenerNombreBanco(document.getElementById('banco').value);
            const usarFechaCorte = document.getElementById('usarFechaCorte').checked;
            let fechaCorte = usarFechaCorte ? document.getElementById('fechaCorte').value : null;
            
            if (!monto || !bancoNombre || (usarFechaCorte && !fechaCorte)) {
                alert("Por favor calcule las cuotas primero");
                return;
            }
            
            const fechaCorteObj = usarFechaCorte ? new Date(fechaCorte) : new Date();
            
            // Crear mensaje para WhatsApp
            let mensaje = *Calculadora de Cuotas - ${bancoNombre}*\n\n;
            mensaje += *Monto financiado:* C$${parseFloat(monto).toLocaleString('es-NI', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n;
            
            if (usarFechaCorte) {
                mensaje += *Fecha de corte:* ${fechaCorteObj.toLocaleDateString('es-NI', {day: '2-digit', month: 'long', year: 'numeric'})}\n\n;
            }
            
            mensaje += *Plan de pagos:*\n;
            
            // Obtener datos de la tabla
            const filas = document.querySelectorAll('#result-content table tbody tr');
            filas.forEach(fila => {
                const celdas = fila.cells;
                mensaje += ➡ ${celdas[0].textContent}: ${celdas[1].textContent};
                
                if (usarFechaCorte) {
                    mensaje += ` (Pago aprox.: ${celdas[3].textContent})`;
                }
                
                mensaje += \n;
            });
            
            // Nota sobre fechas aproximadas si se usa fecha de corte
            if (usarFechaCorte) {
                mensaje += \n_Las fechas de pago son aproximadas y solo a modo de referencia_;
            }
            
            // Codificar mensaje para URL
            const mensajeCodificado = encodeURIComponent(mensaje);
            const whatsappUrl = https://wa.me/?text=${mensajeCodificado};
            
            // Abrir en nueva pestaña
            window.open(whatsappUrl, '_blank');
        }
        
        // Obtener nombre completo del banco
        function obtenerNombreBanco(id) {
            const nombres = {
                bac: 'BAC',
                banpro: 'Banpro',
                ficohsa: 'Ficohsa',
                lafise: 'Lafise'
            };
            return nombres[id] || id;
        }
        
        // Inicializar
        document.getElementById('fechaCorte').valueAsDate = new Date();
        toggleFechaCorte();
    </script>
</body>
</html>